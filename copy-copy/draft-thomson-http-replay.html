<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Using Early Data in HTTP</title>

  
<style type="text/css">/*<![CDATA[*/
@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}

@media screen and (min-width: 1024px) {
  ul.toc, #rfc\.toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 525px);
    width: 300px;
    z-index: 1;
  }
  #rfc\.toc {
    top: 15px;
  }
  ul.toc {
    top: 80px;
    overflow: auto;
  }

  body {
    padding-right: 350px;
  }
}

body {
  font: 15px "Helvetica Neue",Helvetica,Arial,sans-serif;
  color: #333;
  font-size-adjust: 0.5;
  line-height: 130%;
  margin: 25px auto;
  max-width: 724px;
}

.title, .filename, h1, h2, h3, h4 {
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size-adjust: 0.5;
  font-weight: 500;
  color: #333;
  line-height: 100%;
  margin: 0.8em 0 0.3em;
}
.title { font-size: 36px; }
h1 { font-size: 30px; }
h2 { font-size: 24px; }
h3, h4 { font-size: 18px; }
h1 a[href], h2 a[href], h3 a[href], h4 a[href] {
  color: #333;
}

ul.toc li {
  list-style: none;
  text-indent: -2.5em;
  padding-left: 2.5em;
  padding-bottom: 5px;
  margin: 0;
}
ul.toc ul {
  margin: 0;
}
/* xml2rfc nests ul directly inside ul which messes with the style badly */
ul.toc, ul.toc>ul, ul.toc ul>ul {
  margin: 0 0 0 1.5em;
}

table {
  margin-left: 0em;
  border-collapse: collapse;
}
th {
  text-align: left;
  border-bottom: 2px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
  vertical-align: top;
}
tr:nth-child(2n+1) > td,
tr:nth-child(2n+1) > th {
  background-color: #f9f9f9;
}
td.reference {
  max-width: 200px;
  border-top: none;
  padding-right: 1em;
}
.right {
  text-align: right;
}


table.header {
  width: 100%;
}
table.header td {
  border: none;
  background-color: transparent;
  color: black;
}
.filename {
  color: rgb(119, 119, 119);
  font-size: 23px;
  font-weight: normal;
  height: auto;
  line-height: 100%;
}
#rfc\.abstract+p {
  font-size: 20px;
  font-weight: 300;
  line-height: 130%;
}

samp, tt, code, pre {
  font: 11pt consolas, monospace;
  font-size-adjust: none;
}
pre {
  background-color: #eee;
  border: 1px solid #ddd;
  overflow-x: auto;
  padding: 5px;
  margin: 5px;
}
.figure {
  font-style: italic;
  margin: 0 1.5em;
}

address {
  margin: 10px 0 0;
}
.vcard {
  font-style: normal;
}
.vcardline {
  display: block;
}
.vcardline .fn {
  font-weight: bold;
}
.vcardline .hidden {
  display: none;
}

dl {
  margin-left: 1em;
}
dl.dl-horizontal: {
  margin-left: 0;
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl.nohang > dt {
  float: none;
}
dl > dd {
  margin-bottom: .5em;
}
dl.compact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
ul.empty {
  list-style-type: none;
}
ul.empty li {
  margin-top: .5em;
}

hr {
  border: 0;
  border-top: 1px solid #eee;
}

a {
  text-decoration: none;
}
a[href] {
  color: #2a6496;
}
a[href]:hover {
  background-color: #eee;
}

ol, ul, li, p {
  padding: 0;
  margin: 0.5em 0 0.5em 2em;
}
li, p {
  margin-left: 0;
}
address {
  font-style: normal;
}

.github-fork-ribbon-wrapper {
  display: none;
}
@media screen and (min-width: 800px) {
  /* "Fork me on GitHub" CSS ribbon based on
   * https://github.com/simonwhitaker/github-fork-ribbon-css
   */
  .github-fork-ribbon {
    position: absolute;
    padding: 2px 0;
    background-color: #a00;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);
    font: 700 12px "Helvetica Neue", Helvetica, Arial, sans-serif;

    pointer-events: auto;

    top: 38px;
    right: -45px;

    transform: rotate(45deg);
  }

  .github-fork-ribbon a[href],
  .github-fork-ribbon a[href]:hover {
    color: #fff;
    background-color: transparent;
    text-decoration: none;
    text-shadow: 0 -1px rgba(0, 0, 0, 0.5);
    text-align: center;

    width: 190px;
    line-height: 18px;

    display: inline-block;
    padding: 2px 0;

    border: 1.5px dotted #fff;
    border-color: rgba(255, 255, 255, 0.6);
  }

  .github-fork-ribbon-wrapper {
    display: block;
    width: 130px;
    height: 130px;
    position: absolute;
    overflow: hidden;
    top: 0; right: 0;
    z-index: 2;
    pointer-events: none;
  }
}
@media screen and (min-width: 1000px) {
  .github-fork-ribbon-wrapper {
    position: fixed;
  }
  /*]]>*/</style>


  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Conventions and Definitions">
<link href="#rfc.section.2" rel="Chapter" title="2 Early Data in HTTP">
<link href="#rfc.section.3" rel="Chapter" title="3 Supporting Early Data in HTTP Servers">
<link href="#rfc.section.4" rel="Chapter" title="4 Using Early Data in HTTP Clients">
<link href="#rfc.section.5" rel="Chapter" title="5 Extensions for Early Data in HTTP">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 The Early-Data Header Field">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 The 4NN (Too Early) Status Code">
<link href="#rfc.section.6" rel="Chapter" title="6 Security Considerations">
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 Gateways and Early Data">
<link href="#rfc.section.6.2" rel="Chapter" title="6.2 Consistent Handling of Early Data">
<link href="#rfc.section.6.3" rel="Chapter" title="6.3 Denial of Service">
<link href="#rfc.section.7" rel="Chapter" title="7 IANA Considerations">
<link href="#rfc.references" rel="Chapter" title="8 References">
<link href="#rfc.references.1" rel="Chapter" title="8.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="8.2 Informative References">
<link href="#rfc.appendix.A" rel="Chapter" title="A Acknowledgments">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content="xml2rfc version 2.6.1 - http://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Thomson, M., Nottingham, M., and W. Tarreau" />
  <meta name="dct.identifier" content="urn:ietf:id:draft-thomson-http-replay-latest" />
  <meta name="dct.issued" scheme="ISO8601" content="2017-8-17" />
  <meta name="dct.abstract" content="This document explains the risks of using early data for HTTP and describes techniques for reducing them. In particular, it defines a mechanism that enables clients to communicate with servers about early data, to assure correct operation." />
  <meta name="description" content="This document explains the risks of using early data for HTTP and describes techniques for reducing them. In particular, it defines a mechanism that enables clients to communicate with servers about early data, to assure correct operation." />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">httpbis</td>
<td class="right">M. Thomson</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Mozilla</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">M. Nottingham</td>
</tr>
<tr>
<td class="left">Expires: February 18, 2018</td>
<td class="right">true</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">W. Tarreau</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">HAProxy Technologies</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">August 17, 2017</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Using Early Data in HTTP<br />
  <span class="filename">draft-thomson-http-replay-latest</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document explains the risks of using early data for HTTP and describes techniques for reducing them. In particular, it defines a mechanism that enables clients to communicate with servers about early data, to assure correct operation.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of This Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on February 18, 2018.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2017 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<ul><li>1.1.   <a href="#rfc.section.1.1">Conventions and Definitions</a>
</li>
</ul><li>2.   <a href="#rfc.section.2">Early Data in HTTP</a>
</li>
<li>3.   <a href="#rfc.section.3">Supporting Early Data in HTTP Servers</a>
</li>
<li>4.   <a href="#rfc.section.4">Using Early Data in HTTP Clients</a>
</li>
<li>5.   <a href="#rfc.section.5">Extensions for Early Data in HTTP</a>
</li>
<ul><li>5.1.   <a href="#rfc.section.5.1">The Early-Data Header Field</a>
</li>
<li>5.2.   <a href="#rfc.section.5.2">The 4NN (Too Early) Status Code</a>
</li>
</ul><li>6.   <a href="#rfc.section.6">Security Considerations</a>
</li>
<ul><li>6.1.   <a href="#rfc.section.6.1">Gateways and Early Data</a>
</li>
<li>6.2.   <a href="#rfc.section.6.2">Consistent Handling of Early Data</a>
</li>
<li>6.3.   <a href="#rfc.section.6.3">Denial of Service</a>
</li>
</ul><li>7.   <a href="#rfc.section.7">IANA Considerations</a>
</li>
<li>8.   <a href="#rfc.references">References</a>
</li>
<ul><li>8.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>8.2.   <a href="#rfc.references.2">Informative References</a>
</li>
</ul><li>Appendix A.   <a href="#rfc.appendix.A">Acknowledgments</a>
</li>
<li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a>
</h1>
<p id="rfc.section.1.p.1">TLS 1.3 <a href="#TLS13" class="xref">[TLS13]</a> introduces the concept of early data (also known as zero round trip data or 0-RTT data). Early data allows a client to send data to a server in the first round trip of a connection, without waiting for the TLS handshake to complete if the client has spoken to the same server recently.</p>
<p id="rfc.section.1.p.2">When used with HTTP <a href="#HTTP" class="xref">[HTTP]</a>, early data allows clients to send requests immediately, avoiding the one or two round trip delay needed for the TLS handshake. This is a significant performance enhancement; however, it has significant limitations.</p>
<p id="rfc.section.1.p.3">The primary risk of using early data is that an attacker might capture and replay the request(s) it contains. TLS <a href="#TLS13" class="xref">[TLS13]</a> describes techniques that can be used to reduce the likelihood that an attacker can successfully replay a request, but these techniques can be difficult to deploy, and still leave some possibility of a successful attack.</p>
<p id="rfc.section.1.p.4">Note that this is different from automated or user-initiated retries; replays are initiated by an attacker without the awareness of the client.</p>
<p id="rfc.section.1.p.5">To help mitigate the risk of replays in HTTP, this document gives an overview of techniques for controlling these risks in servers, and defines requirements for clients when sending requests in early data.</p>
<p id="rfc.section.1.p.6">The advice in this document also applies to use of 0-RTT in HTTP over QUIC <a href="#HQ" class="xref">[HQ]</a>.</p>
<h2 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> <a href="#conventions-and-definitions" id="conventions-and-definitions">Conventions and Definitions</a>
</h2>
<p id="rfc.section.1.1.p.1">The words &#8220;MUST&#8221;, &#8220;MUST NOT&#8221;, &#8220;SHOULD&#8221;, and &#8220;MAY&#8221; are used in this document.  It&#8217;s not shouting; when they are capitalized, they have the special meaning defined in <a href="#RFC2119" class="xref">[RFC2119]</a>.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#early-data-in-http" id="early-data-in-http">Early Data in HTTP</a>
</h1>
<p id="rfc.section.2.p.1">Conceptually, early data is concatenated with other application to form a single stream.  This can mean that requests are entirely contained within early data, or only part of a request is early.  In a multiplexed protocol, like HTTP/2 <a href="#RFC7540" class="xref">[RFC7540]</a> or HTTP/QUIC <a href="#HQ" class="xref">[HQ]</a>, multiple requests might be partially delivered in early data.</p>
<p id="rfc.section.2.p.2">The model that this document assumes is that once the TLS handshake completes, the early data received on that TLS connection is known to not be a replayed copy of that data.  However, it is important to note that this does not mean that early data will not be or has not been replayed on another connection.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#supporting-early-data-in-http-servers" id="supporting-early-data-in-http-servers">Supporting Early Data in HTTP Servers</a>
</h1>
<p id="rfc.section.3.p.1">A server decides whether or not to offer a client the ability to send early data on future connections when sending the TLS session ticket.</p>
<p id="rfc.section.3.p.2">When a server enables early data, there are a number of techniques it can use to mitigate the risks of replay:</p>
<p></p>

<ol>
<li>The server can choose whether it will process early data before the TLS handshake completes. By deferring processing, it can ensure that only a successfully completed connection is used for the request(s) therein.  Assuming that a replayed ClientHello will not result in additional connections being made by the client, this provides the server with some assurance that the early data was not replayed.</li>
<li>If the server receives multiple requests in early data, it can determine whether to defer HTTP processing on a per-request basis. This may require buffering the responses to preserve ordering in HTTP/1.1.</li>
<li>The server can cause a client to retry a request and not use early data by responding with the 4NN (Too Early) status code (<a href="#status" class="xref">Section 5.2</a>), in cases where the risk of replay is judged too great.</li>
<li>Finally, TLS <a href="#TLS13" class="xref">[TLS13]</a> describes several mitigation strategies that reduce the ability of an attacker to successfully replay early data. Servers are strongly encouraged to implement these techniques, but to also recognize that they are imperfect.  These anti-replay techniques can reduce the number of replays that will be successful from being essentially unbounded to a fixed value.</li>
</ol>
<p id="rfc.section.3.p.4">For a given request, the level of tolerance to replay risk is specific to the resource it operates upon (and therefore only known to the origin server). In general, if processing a request does not have state-changing side effects, the consequences of replay are not significant.</p>
<p id="rfc.section.3.p.5">The request method&#8217;s safety (<a href="#RFC7231" class="xref">[RFC7231]</a>, Section 4.2.1) is one way to determine this. However, some resources do elect to associate side effects with safe methods, so this cannot be universally relied upon.</p>
<p id="rfc.section.3.p.6">It is RECOMMENDED that origin servers allow resources to explicitly configure whether early data is appropriate in requests. Absent such explicit information, they SHOULD mitigate against early data in requests that have unsafe methods, using the techniques outlined above.</p>
<p id="rfc.section.3.p.7">A request might be sent partially in early data with the remainder of the request being sent after the handshake completes.  This does not necessarily affect handling of that request; what matters is when the server starts acting upon the contents of a request.  Any time a server might initiate processing prior to completion of the handshake it needs to consider how a possible replay of early data could affect that processing (see also <a href="#be-consistent" class="xref">Section 6.2</a>).</p>
<p id="rfc.section.3.p.8">A server can partially process requests that are incomplete.  Parsing header fields - without acting on the values - and determining request routing is likely to be safe from side-effects, but other actions might not be.</p>
<p id="rfc.section.3.p.9">Intermediary servers do not have sufficient information to make this determination, so <a href="#status" class="xref">Section 5.2</a> describes a way for the origin to signal to them that a particular request isn&#8217;t appropriate for early data. Intermediaries that accept early data MUST implement that mechanism.</p>
<p id="rfc.section.3.p.10">Note that a server cannot choose to selectively reject early data at the TLS layer. TLS only permits a server to accept all early data, or none of it. Once a server has decided to accept early data, it MUST process all requests in early data, even if the server rejects the request by sending a 4NN (Too Early) response.</p>
<p id="rfc.section.3.p.11">A server can limit the amount of early data with the <samp>max_early_data_size</samp> field of the <samp>early_data</samp> TLS extension. This can be used to avoid committing an arbitrary amount of memory for deferred requests. A server SHOULD ensure that when it accepts early data, it can defer processing of requests until after the TLS handshake completes.</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#using-early-data-in-http-clients" id="using-early-data-in-http-clients">Using Early Data in HTTP Clients</a>
</h1>
<p id="rfc.section.4.p.1">A client that wishes to use early data commences sending HTTP requests immediately after sending the TLS ClientHello.</p>
<p id="rfc.section.4.p.2">By their nature, clients have control over whether a given request is sent in early data &#8211; thereby giving the client control over risk of replay. Absent other information, clients MAY send requests with safe HTTP methods (see <a href="#RFC7231" class="xref">[RFC7231]</a>, Section 4.2.1) in early data when it is available, and SHOULD NOT send unsafe methods (or methods whose safety is not known) in early data.</p>
<p id="rfc.section.4.p.3">If the server rejects early data at the TLS layer, a client MUST start sending again as though the connection was new. For HTTP/2, this means re-sending the connection preface. Any requests sent in early data MUST be sent again, unless the client decides to abandon those requests.</p>
<p id="rfc.section.4.p.4">This automatic retry exposes the request to a potential replay attack.  An attacker sends early data to one server instance that accepts and processes the early data, but allows that connection to proceed no further.  The attacker then forwards the same messages from the client to another server instance that will reject early data.  The client the retries the request, resulting in the request being processed twice.  Replays are also possible if there are multiple server instances that will accept early data, or if the same server accepts early data multiple times (though this would be in violation of requirements in TLS).</p>
<p id="rfc.section.4.p.5">Clients that use early data MUST retry requests upon receipt of a 4NN (Too Early) status code; see <a href="#status" class="xref">Section 5.2</a>.</p>
<p id="rfc.section.4.p.6">An intermediary MUST NOT use early data when forwarding a request unless early data was used on a previous hop, or it knows that the request can be retried safely without consequences (typically, using out-of-band configuration).  Absent better information, that means that an intermediary can only use early data if the request either arrived in early data or arrived with the <samp>Early-Data</samp> header field set to &#8220;1&#8221;.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#extensions-for-early-data-in-http" id="extensions-for-early-data-in-http">Extensions for Early Data in HTTP</a>
</h1>
<p id="rfc.section.5.p.1">Because HTTP requests can span multiple &#8220;hops&#8221;, it is necessary to explicitly communicate whether a request has been sent in early data on a previous connection. Likewise, some means of explicitly triggering a retry when early data is not desirable is necessary. Finally, it is necessary to know whether the client will actually perform such a retry.</p>
<p id="rfc.section.5.p.2">To meet these needs, two signalling mechanisms are defined:</p>
<p></p>

<ul>
<li>The <samp>Early-Data</samp> header field is included in requests that are received in early data.</li>
<li>The 4NN (Too Early) status code is defined for a server to indicate that a request could not be processed due to the consequences of a possible replay attack.</li>
</ul>
<p id="rfc.section.5.p.4">They are designed to enable better coordination of the use of early data between the user agent and origin server, and also when a gateway (also &#8220;reverse proxy&#8221;, &#8220;Content Delivery Network&#8221;, or &#8220;surrogate&#8221;) is present.</p>
<p id="rfc.section.5.p.5">Gateways typically don&#8217;t have specific information about whether a given request can be processed safely when it is sent in early data. In many cases, only the origin server has the necessary information to decide whether the risk of replay is acceptable. These extensions allow coordination between a gateway and its origin server.</p>
<h2 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> <a href="#header" id="header">The Early-Data Header Field</a>
</h2>
<p id="rfc.section.5.1.p.1">The <samp>Early-Data</samp> request header field indicates that the request has been conveyed in early data, and additionally indicates that a client understands the 4NN (Too Early) status code.</p>
<p id="rfc.section.5.1.p.2">It has just one valid value: &#8220;1&#8221;. Its syntax is defined by the following ABNF <a href="#ABNF" class="xref">[ABNF]</a>:</p>
<pre>
Early-Data = "1"
</pre>
<p id="rfc.section.5.1.p.3">For example:</p>
<pre>
GET /resource HTTP/1.0
Host: example.com
Early-Data: 1
</pre>
<p id="rfc.section.5.1.p.4">An intermediary that forwards a request received in TLS early data MUST send it with the <samp>Early-Data</samp> header field set to &#8220;1&#8221; (i.e., it adds it if not present in the request).</p>
<p id="rfc.section.5.1.p.5">An intermediary MUST NOT remove this header field if it is present in a request.</p>
<p id="rfc.section.5.1.p.6">The <samp>Early-Data</samp> header field is not intended for use by user agents (that is, the original initiator of a request).  Sending a request in early data implies that the client understands this specification and is willing to retry a request in response to a 4NN (Too Early) status code.  A user agent that sends a request in early data does not need to include the <samp>Early-Data</samp> header field.</p>
<p id="rfc.section.5.1.p.7">A server cannot make a request that contains the Early-Data header field safe for processing by waiting for the handshake to complete. A request that is marked with Early-Data was sent in early data on a previous hop. Requests that contain the Early-Data field and cannot be safely processed MUST be rejected using the 4NN (Too Early) status code.</p>
<h2 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> <a href="#status" id="status">The 4NN (Too Early) Status Code</a>
</h2>
<p id="rfc.section.5.2.p.1">A 4NN (Too Early) status code indicates that the server is unwilling to risk processing a request that might be replayed.</p>
<p id="rfc.section.5.2.p.2">Clients (user-agents and intermediaries) that sent the request in early data MUST automatically retry the request when receiving a 4NN (Too Early) response status code. Such retries MUST NOT be sent in early data, and SHOULD NOT be sent if the TLS handshake on the original connection does not successfully complete.</p>
<p id="rfc.section.5.2.p.3">Intermediaries that receive a 4NN (Too Early) status code MAY automatically retry requests after allowing the handshake to complete unless the original request contained the <samp>Early-Data</samp> header field when it was received.  Otherwise, an intermediary MUST forward the 4NN (Too Early) status code.</p>
<p id="rfc.section.5.2.p.4">The server cannot assume that a client is able to retry a request unless the request is received in early data or the <samp>Early-Data</samp> header field is set to &#8220;1&#8221;.  A server SHOULD NOT emit the 4NN status code unless one of these conditions is met.</p>
<p id="rfc.section.5.2.p.5">The 4NN (Too Early) status code is not cacheable by default. Its payload is not the representation of any identified resource.</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#security-considerations" id="security-considerations">Security Considerations</a>
</h1>
<p id="rfc.section.6.p.1">Using early data exposes a client to the risk that their request is replayed.  A retried or replayed request can produce different side effects on the server.  In addition to those side effects, replays and retries might be used for traffic analysis to recover information about requests or the resources those requests target.</p>
<h2 id="rfc.section.6.1">
<a href="#rfc.section.6.1">6.1.</a> <a href="#gateways-and-early-data" id="gateways-and-early-data">Gateways and Early Data</a>
</h2>
<p id="rfc.section.6.1.p.1">A gateway that forwards requests that were received in early data MUST only do so if it knows that the server that receives those requests understands the <samp>Early-Data</samp> header field and will correctly generate a 4NN (Too Early) status code.  A gateway that isn&#8217;t certain about server support SHOULD either delay forwarding the request until the TLS handshake completes, or send a 4NN (Too Early) status code in response.  A gateway that is uncertain about whether an origin server supports the <samp>Early-Data</samp> header field SHOULD disable early data.</p>
<h2 id="rfc.section.6.2">
<a href="#rfc.section.6.2">6.2.</a> <a href="#be-consistent" id="be-consistent">Consistent Handling of Early Data</a>
</h2>
<p id="rfc.section.6.2.p.1">Consistent treatment of a request that arrives in - or partially in - early data is critical to avoiding inappropriate processing of replayed requests.  If a request is not safe to process before the TLS handshake completes, then all instances of the server need to agree and either reject the request or delay processing.</p>
<h2 id="rfc.section.6.3">
<a href="#rfc.section.6.3">6.3.</a> <a href="#denial-of-service" id="denial-of-service">Denial of Service</a>
</h2>
<p id="rfc.section.6.3.p.1">Accepting early data exposes a server to potential denial of service through the replay of requests that are expensive to handle.  A server that is under load SHOULD prefer rejecting TLS early data as a whole rather than accepting early data and selectively processing requests.  Generating a 503 (Service Unavailable) or 4NN (Too Early) status code often leads to clients retrying requests, which could result in increased load.</p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#iana-considerations" id="iana-considerations">IANA Considerations</a>
</h1>
<p id="rfc.section.7.p.1">This document registers the <samp>Early-Data</samp> header field in the &#8220;Message Headers&#8221; registry <a href="#HEADERS" class="xref">[HEADERS]</a>.</p>
<p></p>

<dl>
<dt>Header field name:</dt>
<dd style="margin-left: 8">Early-Data</dd>
<dt>Applicable protocol:</dt>
<dd style="margin-left: 8">http</dd>
<dt>Status:</dt>
<dd style="margin-left: 8">standard</dd>
<dt>Author/Change controller:</dt>
<dd style="margin-left: 8">IETF</dd>
<dt>Specification document(s):</dt>
<dd style="margin-left: 8">This document</dd>
<dt>Related information:</dt>
<dd style="margin-left: 8">(empty)</dd>
</dl>
<p id="rfc.section.7.p.3">This document registers the 4NN (Too Early) status code in the &#8220;Hypertext Transfer Protocol (HTTP) Status Code&#8221; registry established in <a href="#RFC7231" class="xref">[RFC7231]</a>.</p>
<p></p>

<dl>
<dt>Value:</dt>
<dd style="margin-left: 8">4NN</dd>
<dt>Description:</dt>
<dd style="margin-left: 8">Too Early</dd>
<dt>Reference:</dt>
<dd style="margin-left: 8">This document</dd>
</dl>
<h1 id="rfc.references">
<a href="#rfc.references">8.</a> References</h1>
<h2 id="rfc.references.1">
<a href="#rfc.references.1">8.1.</a> Normative References</h2>
<table><tbody>
<tr>
<td class="reference"><b id="ABNF">[ABNF]</b></td>
<td class="top">
<a>Crocker, D.</a> and <a>P. Overell</a>, "<a href="http://tools.ietf.org/html/rfc5234">Augmented BNF for Syntax Specifications: ABNF</a>", STD 68, RFC 5234, DOI 10.17487/RFC5234, January 2008.</td>
</tr>
<tr>
<td class="reference"><b id="HEADERS">[HEADERS]</b></td>
<td class="top">
<a>Klyne, G.</a>, <a>Nottingham, M.</a> and <a>J. Mogul</a>, "<a href="http://tools.ietf.org/html/rfc3864">Registration Procedures for Message Header Fields</a>", BCP 90, RFC 3864, DOI 10.17487/RFC3864, September 2004.</td>
</tr>
<tr>
<td class="reference"><b id="HTTP">[HTTP]</b></td>
<td class="top">
<a>Fielding, R.</a> and <a>J. Reschke</a>, "<a href="http://tools.ietf.org/html/rfc7230">Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing</a>", RFC 7230, DOI 10.17487/RFC7230, June 2014.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a>Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7231">[RFC7231]</b></td>
<td class="top">
<a>Fielding, R.</a> and <a>J. Reschke</a>, "<a href="http://tools.ietf.org/html/rfc7231">Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content</a>", RFC 7231, DOI 10.17487/RFC7231, June 2014.</td>
</tr>
<tr>
<td class="reference"><b id="TLS13">[TLS13]</b></td>
<td class="top">
<a>Rescorla, E.</a>, "<a href="http://tools.ietf.org/html/draft-ietf-tls-tls13-21">The Transport Layer Security (TLS) Protocol Version 1.3</a>", Internet-Draft draft-ietf-tls-tls13-21, July 2017.</td>
</tr>
</tbody></table>
<h2 id="rfc.references.2">
<a href="#rfc.references.2">8.2.</a> Informative References</h2>
<table><tbody>
<tr>
<td class="reference"><b id="HQ">[HQ]</b></td>
<td class="top">
<a>Bishop, M.</a>, "<a href="http://tools.ietf.org/html/draft-ietf-quic-http-05">Hypertext Transfer Protocol (HTTP) over QUIC</a>", Internet-Draft draft-ietf-quic-http-05, August 2017.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7540">[RFC7540]</b></td>
<td class="top">
<a>Belshe, M.</a>, <a>Peon, R.</a> and <a>M. Thomson</a>, "<a href="http://tools.ietf.org/html/rfc7540">Hypertext Transfer Protocol Version 2 (HTTP/2)</a>", RFC 7540, DOI 10.17487/RFC7540, May 2015.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.A">
<a href="#rfc.appendix.A">Appendix A.</a> <a href="#acknowledgments" id="acknowledgments">Acknowledgments</a>
</h1>
<p id="rfc.section.A.p.1">This document was not easy to produce.  The following people made substantial contributions to the quality and completeness of the document: Subodh Iyengar, Benjamin Kaduk, Ilari Liusavaara, Kazuho Oku, and Victor Vasiliev.</p>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Martin Thomson</span> 
	  <span class="n hidden">
		<span class="family-name">Thomson</span>
	  </span>
	</span>
	<span class="org vcardline">Mozilla</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:martin.thomson@gmail.com">martin.thomson@gmail.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Mark Nottingham</span> 
	  <span class="n hidden">
		<span class="family-name">Nottingham</span>
	  </span>
	</span>
	<span class="org vcardline">true</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:mnot@mnot.net">mnot@mnot.net</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Willy Tarreau</span> 
	  <span class="n hidden">
		<span class="family-name">Tarreau</span>
	  </span>
	</span>
	<span class="org vcardline">HAProxy Technologies</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:willy@haproxy.org">willy@haproxy.org</a></span>

  </address>
</div>

  <div class="github-fork-ribbon-wrapper"><div class="github-fork-ribbon"><a href="https://github.com/martinthomson/http-replay">Fork me on GitHub</a></div></div>
</body>
</html>
